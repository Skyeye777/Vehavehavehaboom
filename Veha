<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Fish Boom Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 {
      margin-top: 10px;
    }
    #top-panel {
      margin: 10px auto;
      max-width: 600px;
    }
    input, button {
      padding: 6px 10px;
      margin: 4px;
      font-size: 14px;
    }
    #status {
      margin: 10px 0;
      min-height: 40px;
    }
    #game {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .board-wrapper {
      background: #ffffff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .board-title {
      margin-bottom: 6px;
      font-weight: bold;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(5, 40px);
      gap: 4px;
      justify-content: center;
    }
    .cell {
      width: 40px;
      height: 40px;
      background: #ffffff;
      border: 1px solid #aaa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      box-sizing: border-box;
    }
    .cell.disabled {
      cursor: default;
      background: #e9e9e9;
    }
    .cell img {
      max-width: 36px;
      max-height: 36px;
      pointer-events: none;
    }
    #info {
      margin-top: 10px;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Fish Boom Online</h1>

  <div id="top-panel">
    <div>
      –ö–æ–º–Ω–∞—Ç–∞:
      <input id="roomInput" placeholder="room123">
      <button id="createRoomBtn">–°–æ–∑–¥–∞—Ç—å</button>
      <button id="joinRoomBtn">–í–æ–π—Ç–∏</button>
    </div>
    <div id="status">–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ.</div>
  </div>

  <div id="game" style="display:none;">
    <div class="board-wrapper">
      <div class="board-title">–¢–≤–æ—ë –ø–æ–ª–µ (—Ä—ã–±–∫–∏-–º–∏–Ω—ã)</div>
      <div id="myBoard" class="board"></div>
    </div>
    <div class="board-wrapper">
      <div class="board-title">–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ (—Å—Ç—Ä–µ–ª—è–µ—à—å —Å—é–¥–∞)</div>
      <div id="enemyBoard" class="board"></div>
    </div>
  </div>

  <div id="info">
    –ü—Ä–∞–≤–∏–ª–∞: —É –∫–∞–∂–¥–æ–≥–æ 5 —Ä—ã–±–æ–∫-–º–∏–Ω. –†—ã–±–∫–∏ —Å–∫—Ä—ã—Ç—ã. –ü–æ–ø–∞–¥–∞–Ω–∏–µ = –≤–∑—Ä—ã–≤ üí•, –ø—Ä–æ–º–∞—Ö = ‚Ä¢.<br>
    –ï—Å–ª–∏ –¢–´ –æ—Ç–∫—Ä—ã–ª –≤—Å–µ 5 —Ä—ã–±–æ–∫ –ü–†–û–¢–ò–í–ù–ò–ö–ê ‚Äî –≤–∑–æ—Ä–≤–∞–ª—Å—è –¢–´ –∏ –¢–´ –ø—Ä–æ–∏–≥—Ä–∞–ª.<br>
    –ï—Å–ª–∏ –û–ù –æ—Ç–∫—Ä—ã–ª –≤—Å–µ 5 –¢–í–û–ò–• —Ä—ã–±–æ–∫ ‚Äî –≤–∑–æ—Ä–≤–∞–ª—Å—è –û–ù –∏ –û–ù –ø—Ä–æ–∏–≥—Ä–∞–ª.
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    /* üî• –¢–í–û–ò –î–ê–ù–ù–´–ï FIREBASE ‚Äî –£–ñ–ï –í–°–¢–ê–í–õ–ï–ù–´ */
    const firebaseConfig = {
      apiKey: "AIzaSyDvUVT46E2t0gKxdBdInXEriBjhZmhBCG8",
      authDomain: "booooooom-2a58a.firebaseapp.com",
      projectId: "booooooom-2a58a",
      storageBucket: "booooooom-2a58a.firebasestorage.app",
      messagingSenderId: "230783528096",
      appId: "1:230783528096:web:5e43fa74549f699f8b6dc5",
      measurementId: "G-G4191PB4TJ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const FISH_IMG = "https://i.postimg.cc/KjbMP4xG/IMG-20260128-174245.jpg";
    const EXPLOSION_IMG = "https://i.postimg.cc/t4n4gpGL/Bez-nazvania160-20260128173816.png";

    const roomInput = document.getElementById('roomInput');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const statusEl = document.getElementById('status');
    const gameEl = document.getElementById('game');
    const myBoardEl = document.getElementById('myBoard');
    const enemyBoardEl = document.getElementById('enemyBoard');

    const SIZE = 5;
    const FISH_COUNT = 5;

    let roomId = null;
    let playerId = null;
    let myFishPositions = [];
    let myFishRevealedByEnemy = 0;
    let myShotsOnEnemy = 0;
    let phase = "placing";
    let isMyTurn = false;

    let myBoardCells = [];
    let enemyBoardCells = [];

    function setStatus(text) {
      statusEl.innerHTML = text;
    }

    function createBoards() {
      myBoardEl.innerHTML = "";
      enemyBoardEl.innerHTML = "";
      myBoardCells = [];
      enemyBoardCells = [];

      for (let i = 0; i < SIZE * SIZE; i++) {
        const myCell = document.createElement('div');
        myCell.className = 'cell';
        myCell.dataset.index = i;
        myCell.addEventListener('click', onMyBoardClick);
        myBoardEl.appendChild(myCell);
        myBoardCells.push(myCell);

        const enemyCell = document.createElement('div');
        enemyCell.className = 'cell disabled';
        enemyCell.dataset.index = i;
        enemyCell.addEventListener('click', onEnemyBoardClick);
        enemyBoardEl.appendChild(enemyCell);
        enemyBoardCells.push(enemyCell);
      }
    }

    function onMyBoardClick(e) {
      if (phase !== "placing") return;
      const idx = parseInt(e.currentTarget.dataset.index, 10);
      const cell = myBoardCells[idx];

      if (myFishPositions.includes(idx)) {
        myFishPositions = myFishPositions.filter(x => x !== idx);
        cell.innerHTML = "";
      } else {
        if (myFishPositions.length >= FISH_COUNT) {
          setStatus("–£ —Ç–µ–±—è —É–∂–µ 5 —Ä—ã–±–æ–∫. –ù–∞–∂–º–∏ –Ω–∞ —Ä—ã–±–∫—É, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å.");
          return;
        }
        myFishPositions.push(idx);
        cell.innerHTML = '<img src="' + FISH_IMG + '">';
      }

      saveMyFish();
    }

    function onEnemyBoardClick(e) {
      if (phase !== "battle") return;
      if (!isMyTurn) return;

      const idx = parseInt(e.currentTarget.dataset.index, 10);
      const cell = enemyBoardCells[idx];

      if (cell.dataset.shot === "1") return;
      cell.dataset.shot = "1";

      db.ref("rooms/" + roomId + "/shots").push({
        from: playerId,
        index: idx,
        timestamp: Date.now()
      });

      isMyTurn = false;
      updateTurnStatus();
    }

    function saveMyFish() {
      if (!roomId || !playerId) return;
      db.ref("rooms/" + roomId + "/players/" + playerId + "/fish").set(myFishPositions);
    }

    function markEnemyHit(index) {
      enemyBoardCells[index].innerHTML = '<img src="' + EXPLOSION_IMG + '">';
    }

    function markEnemyMiss(index) {
      enemyBoardCells[index].textContent = '‚Ä¢';
    }

    function markMyHitByEnemy(index) {
      myBoardCells[index].innerHTML = '<img src="' + EXPLOSION_IMG + '">';
    }

    function markMyMissByEnemy(index) {
      myBoardCells[index].textContent = '‚Ä¢';
    }

    function disableAllCells() {
      enemyBoardCells.forEach(c => c.classList.add('disabled'));
      myBoardCells.forEach(c => c.classList.add('disabled'));
    }

    function updateTurnStatus() {
      if (phase !== "battle") return;
      if (isMyTurn) {
        setStatus("–¢–≤–æ–π —Ö–æ–¥. –°—Ç—Ä–µ–ª—è–π –ø–æ –ø–æ–ª—é –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞.");
        enemyBoardCells.forEach(c => c.classList.remove('disabled'));
      } else {
        setStatus("–•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞. –ñ–¥–∏ –µ–≥–æ –≤—ã—Å—Ç—Ä–µ–ª–∞.");
        enemyBoardCells.forEach(c => c.classList.add('disabled'));
      }
    }

    function startBattleIfReady(snapshot) {
      const players = snapshot.val();
      if (!players) return;
      if (!players.p1 || !players.p2) return;
      if (!players.p1.fish || !players.p2.fish) return;
      if (phase !== "placing") return;

      phase = "battle";
      setStatus("–û–±–∞ —Ä–∞—Å—Å—Ç–∞–≤–∏–ª–∏ —Ä—ã–±–æ–∫. –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –±–æ–π!");

      db.ref("rooms/" + roomId + "/state/currentTurn").once("value").then(snap => {
        if (!snap.exists()) {
          db.ref("rooms/" + roomId + "/state/currentTurn").set("p1");
        }
      });
    }

    function listenRoom() {
      db.ref("rooms/" + roomId + "/players").on("value", snapshot => {
        startBattleIfReady(snapshot);
      });

      db.ref("rooms/" + roomId + "/state/currentTurn").on("value", snapshot => {
        if (!snapshot.exists()) return;
        isMyTurn = (snapshot.val() === playerId);
        updateTurnStatus();
      });

      db.ref("rooms/" + roomId + "/shots").on("child_added", snapshot => {
        handleShot(snapshot.val());
      });

      db.ref("rooms/" + roomId + "/state/winner").on("value", snapshot => {
        if (!snapshot.exists()) return;
        if (phase === "ended") return;

        phase = "ended";
        disableAllCells();

        const winner = snapshot.val();
        if (winner === playerId) {
          setStatus('<img src="' + EXPLOSION_IMG + '" width="80"><br>üí• –¢—ã –≤–∑–æ—Ä–≤–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º. –¢—ã –í–´–ò–ì–†–ê–õ!');
        } else {
          setStatus('<img src="' + EXPLOSION_IMG + '" width="80"><br>üí• –¢—ã –≤–∑–æ—Ä–≤–∞–ª—Å—è –ø–µ—Ä–≤—ã–º. –¢—ã –ü–†–û–ò–ì–†–ê–õ.');
        }
      });
    }

    function handleShot(shot) {
      if (phase !== "battle") return;

      const from = shot.from;
      const idx = shot.index;

      if (from === playerId) {
        const enemyId = (playerId === "p1") ? "p2" : "p1";

        db.ref("rooms/" + roomId + "/players/" + enemyId + "/fish").once("value").then(snap => {
          const fish = snap.val() || [];
          const isHit = fish.includes(idx);

          if (isHit) {
            markEnemyHit(idx);
            myShotsOnEnemy++;

            if (myShotsOnEnemy >= FISH_COUNT) {
              endGame(enemyId);
            }
          } else {
            markEnemyMiss(idx);
          }

          db.ref("rooms/" + roomId + "/state/currentTurn").set(enemyId);
        });

      } else {
        const isHit = myFishPositions.includes(idx);

        if (isHit) {
          markMyHitByEnemy(idx);
          myFishRevealedByEnemy++;

          if (myFishRevealedByEnemy >= FISH_COUNT) {
            endGame(playerId);
          }
        } else {
          markMyMissByEnemy(idx);
        }

        db.ref("rooms/" + roomId + "/state/currentTurn").set(playerId);
      }
    }

    function endGame(winnerId) {
      db.ref("rooms/" + roomId + "/state/winner").set(winnerId);
    }

    function joinRoom(asCreator) {
      const id = roomInput.value.trim();
      if (!id) {
        setStatus("–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã.");
        return;
      }

      roomId = id;
      playerId = null;
      myFishPositions = [];
      myFishRevealedByEnemy = 0;
      myShotsOnEnemy = 0;
      phase = "placing";
      isMyTurn = false;

      createBoards();
      gameEl.style.display = "flex";

      const roomRef = db.ref("rooms/" + roomId);

      roomRef.once("value").then(snapshot => {
        const data = snapshot.val();

        if (!data) {
          if (!asCreator) {
            setStatus("–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.");
            gameEl.style.display = "none";
            return;
          }

          playerId = "p1";
          roomRef.set({
            players: { p1: { fish: [] } },
            state: { currentTurn: "p1" }
          });

          setStatus("–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞. –¢—ã ‚Äî –ò–≥—Ä–æ–∫ 1. –†–∞—Å—Å—Ç–∞–≤—å 5 —Ä—ã–±–æ–∫.");
          listenRoom();
          return;
        }

        const players = data.players || {};

        if (!players.p1) {
          playerId = "p1";
          roomRef.child("players/p1").set({ fish: [] });
          setStatus("–¢—ã ‚Äî –ò–≥—Ä–æ–∫ 1. –†–∞—Å—Å—Ç–∞–≤—å 5 —Ä—ã–±–æ–∫.");
        } else if (!players.p2) {
          playerId = "p2";
          roomRef.child("players/p2").set({ fish: [] });
          setStatus("–¢—ã ‚Äî –ò–≥—Ä–æ–∫ 2. –†–∞—Å—Å—Ç–∞–≤—å 5 —Ä—ã–±–æ–∫.");
        } else {
          setStatus("–í –∫–æ–º–Ω–∞—Ç–µ —É–∂–µ –¥–≤–∞ –∏–≥—Ä–æ–∫–∞.");
          gameEl.style.display = "none";
          return;
        }

        listenRoom();
      });
    }

    createRoomBtn.addEventListener('click', () => joinRoom(true));
    joinRoomBtn.addEventListener('click', () => joinRoom(false));
  </script>
</body>
</html>
